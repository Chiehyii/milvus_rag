---
config:
  layout: dagre
---
flowchart TB
    A["使用者輸入問題"] --> B("開始 chat_pipeline")
    B --> C{"是否有對話歷史?"}
    C -- 是 --> D["重構問題以包含上下文"]
    C -- 否 --> E["使用原始問題"]
    D --> F("意圖分類")
    E --> F
    F --> G{"意圖是 scholarship 嗎?"}
    G -- 是 --> H["1️⃣ 產生問題向量 Embedding"]
    H --> I["2️⃣ 提取 Metadata 過濾條件"]
    I --> J["3️⃣ 在 Milvus 向量資料庫中檢索"]
    J --> K{"有找到相關文件嗎?"}
    K -- 是 --> L["4️⃣ 組合 Prompt（問題 + 文件內容）"]
    L --> M["5️⃣ 呼叫 LLM（gpt-4o-mini）生成答案"]
    M --> N["6️⃣ 解析回答與引用來源"]
    N --> P["準備最終結果"]
    K -- 否 --> O["設定「找不到資訊」的回答"]
    O --> P
    G -- 否 --> Q["直接呼叫 LLM（gpt-4o-mini）回答"]
    Q --> P
    P --> R("記錄問答至 SQLite 資料庫")
    R --> S["返回最終答案給使用者"]
